# MANAGED BY PUPPET from modules/mesaides/templates/nginx_config.erb
# Modifications should be made in that template

<% ssl_section = %{
  ssl_certificate     /etc/letsencrypt/live/#{@name}/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/live/#{@name}/privkey.pem;
  include snippets/ssl_params.conf;
} %>

<% ssl_exists = File.exists?("/etc/letsencrypt/live/#{@name}/fullchain.pem") %>

<% if ssl_exists %>
# REDIRECT HTTP TRAFFIC ON <%= @name %> TO HTTPS
server {

  listen              *:80<% if @is_default %> default_server<% end %>;
  server_name         <%= @name %>;

  location /.well-known {
    root              <%= @webroot_path %>;
  }

  location / {
    return            302 https://<%= @name %>$request_uri;
  }
}
<% end %>

<% if @add_www_subdomain %>
  <% if ssl_exists %>
# REDIRECT HTTP TRAFFIC ON www.<%= @name %> TO <%= @name %> ON HTTPS
server {

  server_name         www.<%= @name %>;

  location /.well-known {
    root              <%= @webroot_path %>;
  }

  listen              *:80;
  access_log          /var/log/nginx/<%= @name %>.access.log combined;
  error_log           /var/log/nginx/<%= @name %>.error.log;

  location / {
    return            302 https://<%= @name %>$request_uri;
  }
}
  <% end %>

# REDIRECT TRAFFIC ON www.<%= @name %> TO <%= @name %>
server {
  server_name         www.<%= @name %>;

  location /.well-known {
    root              <%= @webroot_path %>;
  }

  <% if ssl_exists %>
  listen              443 ssl;
  <%= ssl_section %>
  access_log          /var/log/nginx/<%= @name %>.ssl.access.log combined;
  error_log           /var/log/nginx/<%= @name %>.ssl.error.log;

  location / {
    return            302 https://<%= @name %>$request_uri;
  }
  <% else %>
  listen              *:80;
  access_log          /var/log/nginx/<%= @name %>.access.log combined;
  error_log           /var/log/nginx/<%= @name %>.error.log;

  location / {
    return            302 http://<%= @name %>$request_uri;
  }
  <% end %>
}
<% end %>

# MAIN SERVER
server {

  server_name         <%= @name %>;

  <% if ssl_exists %>
  listen              443 ssl;
  <%= ssl_section %>
  access_log          /var/log/nginx/<%= @name %>.ssl.access.log combined;
  error_log           /var/log/nginx/<%= @name %>.ssl.error.log;
  <% else %>
  listen              *:80<% if @is_default and !ssl_exists %> default_server<% end %>;
  access_log          /var/log/nginx/<%= @name %>.access.log combined;
  error_log           /var/log/nginx/<%= @name %>.error.log;
  <% end %>

  location /.well-known {
    root              <%= @webroot_path %>;
  }

  gzip                on;
  gzip_proxied        any;
  gzip_types          application/json
                      application/javascript
                      text/css
                      text/plain
                      text/xml;
  gzip_vary           on;

  <% if @nginx_root %>
  root <%= @nginx_root %>;

  include snippets/mes-aides-static.conf;

  # WARNING
  # Everything in app/ or dist/ will be served directly by Nginx
  # Do not put any sensitive file there
  location / {
    try_files /dist$uri /app$uri @default;
  }

  location @default {

    # Enable Keepalive Connections
    # https://www.nginx.com/blog/tuning-nginx/#keepalive
    # A number of connections may be defined for each upstream in /etc/nginx/conf.d/upstreams.conf
    proxy_set_header Connection        "";
    proxy_set_header Host              $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version                 1.1;

    proxy_pass        http://<%= @upstream_name %>;
    proxy_redirect    off;
  }
  <% else %>
  location / {

    # Enable Keepalive Connections
    # https://www.nginx.com/blog/tuning-nginx/#keepalive
    # A number of connections may be defined for each upstream in /etc/nginx/conf.d/upstreams.conf
    proxy_set_header Connection        "";
    proxy_set_header Host              $host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version                 1.1;

    proxy_pass        http://<%= @upstream_name %>;
    proxy_redirect    off;
  }
  <% end %>
}
